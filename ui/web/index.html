<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Work Estimation</title>
    <script language="javascript" type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="node_modules/jqplot/jquery.jqplot.min.js"></script>
    <link rel="stylesheet" type="text/css" href="node_modules/jqplot/jquery.jqplot.min.css" />
    <script src="https://www.amcharts.com/lib/4/core.js"></script>
    <script src="https://www.amcharts.com/lib/4/charts.js"></script>
    <script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>    
    <style type="text/css">

        #area{
            display:none;
        }
		#map{
			display: none;
        }
        #creationChart{
            width: 1200px;
            height: 400px;
        }

    </style>
    <script>

        function openMappingDiv(){
            document.getElementById("area").style.display = "block";
        };
        function hideMappingDiv(){
            document.getElementById("area").style.display = "none";
        }
        function openRoadMap(){
        	document.getElementById("map").style.display = "block";
        }

    </script>
</head>
<body>
    <h1>Work Estimation</h1>
    <fieldset>

        <legend>Open file</legend>

        <input type="file" id="excelFile"/>

    </fieldset>

    <fieldset>

        <legend>Reading of tasks</legend>

        <label><input type="text" id="sheetName"> Sheet name</label><br>
        <label><input type="text" id="firstRow"> First row</label><br>
        <label><input type="text" id="lastRow"> Last row</label><br>
        <label><input type="text" id="rowsToSkip"> Rows to skip</label><br>
        <label><input type="button" value="+" onmousedown="openMappingDiv()"></label>
        <label><input type="button" value="-" onmousedown="hideMappingDiv()"></label>

    	<div id="area">

	        <table border="0" widtd="100%">
	            <tr>
	                <td>uid
	                    <select  name="uid" id="uid">
	                        <option value=""></option>
	                        <option value="A">A</option>
	                        <option value="B">B</option>
	                        <option value="C">C</option>
	                        <option value="D">D</option>
	                        <option value="E">E</option>
	                        <option value="F">F</option>
	                        <option value="G">G</option>
	                        <option value="H">H</option>
	                        <option value="I">I</option>
	                        <option value="J">J</option>
	                        <option value="K">K</option>
	                        <option value="L">L</option>            
	                    </select>
	                </td>
	                <td>min_estimate
	                    <select name="min_estimate" id="minEstimate">
	                        <option value=""></option>
	                        <option value="A">A</option>
	                        <option value="B">B</option>
	                        <option value="C">C</option>
	                        <option value="D">D</option>
	                        <option value="E">E</option>
	                        <option value="F">F</option>
	                        <option value="G">G</option>
	                        <option value="H">H</option>
	                        <option value="I">I</option>
	                        <option value="J">J</option>
	                        <option value="K">K</option>
	                        <option value="L">L</option>            
	                    </select>
	                </td>
	            </tr>
	            <tr>                        
	                <td>name
	                    <select name="name" id="name">
	                        <option value=""></option>
	                        <option value="A">A</option>
	                        <option value="B">B</option>
	                        <option value="C">C</option>
	                        <option value="D">D</option>
	                        <option value="E">E</option>
	                        <option value="F">F</option>
	                        <option value="G">G</option>
	                        <option value="H">H</option>
	                        <option value="I">I</option>
	                        <option value="J">J</option>
	                        <option value="K">K</option>
	                        <option value="L">L</option>            
	                    </select>
	                </td>
	                <td>normal_estimate
	                    <select name="normal_estimate" id="normalEstimate">
	                        <option value=""></option>
	                        <option value="A">A</option>
	                        <option value="B">B</option>
	                        <option value="C">C</option>
	                        <option value="D">D</option>
	                        <option value="E">E</option>
	                        <option value="F">F</option>
	                        <option value="G">G</option>
	                        <option value="H">H</option>
	                        <option value="I">I</option>
	                        <option value="J">J</option>
	                        <option value="K">K</option>
	                        <option value="L">L</option>            
	                    </select>
	                </td>
	            </tr>
	            <tr>
	                <td>blockers
	                    <select name="blockers" id="blockers">
	                        <option value=""></option>
	                        <option value="A">A</option>
	                        <option value="B">B</option>
	                        <option value="C">C</option>
	                        <option value="D">D</option>
	                        <option value="E">E</option>
	                        <option value="F">F</option>
	                        <option value="G">G</option>
	                        <option value="H">H</option>
	                        <option value="I">I</option>
	                        <option value="J">J</option>
	                        <option value="K">K</option>
	                        <option value="L">L</option>            
	                    </select>
	                </td>
	                <td>max_estimate
	                    <select name="max_estimate" id="maxEstimate">
	                        <option value=""></option>
	                        <option value="A">A</option>
	                        <option value="B">B</option>
	                        <option value="C">C</option>
	                        <option value="D">D</option>
	                        <option value="E">E</option>
	                        <option value="F">F</option>
	                        <option value="G">G</option>
	                        <option value="H">H</option>
	                        <option value="I">I</option>
	                        <option value="J">J</option>
	                        <option value="K">K</option>
	                        <option value="L">L</option>            
	                    </select>
	                </td>
	                </td>
	            </tr>
	        </table>
    	</div> 

    </fieldset>

    <fieldset>

        <legend>Load</legend>

        <div id="place">

            <input type="submit" name="but" id="loadTasksButton" value="Load" onmousedown="openRoadMap()">

        </div>

    </fieldset>

    <fieldset>

        <legend>Print</legend>

            <table border="0" widtd="100%">
                <tr>
                    <td>Tasks
                        <div id="choiceGraphic"></div>                      
                    </td>
                    <td>
                        <input type="button" value="Print" id="printGraphicButton">
                    </td>
                </tr>
                <tr>
                    <td>
                        <div id="chartdiv" style="height:500px;width:400px; "></div>
                    </td>
                </tr>
                </table>
    </fieldset>

    <div id="map">

	    <fieldset>

	    	<legend>Road map</legend>

	    		<input id="workes" type="text" name="quantity" class="field" value="Number of workers">
				<input id="printMapButton" type="button" value="Build road map">
				<div id="error" style="color:red"></div>
                <div id="creationChart"></div>

	    </fieldset>

	</div>


    <script> 
            var applicationContext = {}; 
            var applicationConstants = {
                LOAD_EXCEL_FILE_TO_SERVER_URL: 'http://localhost:5000/api/excelWorkbook',
                LOAD_TASKS_FROM_SERVER_ERL: 'http://localhost:5000/api/excelWorkbook/tasks',
                LOAD_NORMAL_DISTRIBUTION_FROM_SERVER_URL: 'http://localhost:5000/api/tasks/normalDistribution',
                LOAD_ROAD_MAP_FROM_SERVER_URL: 'http://localhost:5000/api/tasks/roadMap',
                NUMBER_OF_NORMAL_DISTRIBUTION_POINTS: 50
            }                                 
        function loadTasks() {
            var excelFile = $('#excelFile').get(0).files.item(0);
            $.ajax({
                type: 'PUT',
                url: applicationConstants.LOAD_EXCEL_FILE_TO_SERVER_URL,
                data: excelFile,
                contentType: 'application/vnd.ms-excel',
                processData: false,
                success: function (data) {
                    var requestBody = {
                        file: data.tempFileName,
                        sheet: $("#sheetName").val(),
                        first_row: +$("#firstRow").val(),
                        last_row: +$("#lastRow").val(),
                        rows_to_skip: $("#rowsToSkip").val(),
                        columns_mapping: {
                            uid: $("#uid").val(),
                            name: $("#name").val(),
                            blockers: $("#blockers").val(),
                            min_estimate: $("#minEstimate").val(),
                            normal_estimate: $("#normalEstimate").val(),
                            max_estimate: $("#maxEstimate").val()
                        }
                    };
                    $.ajax({
                        type: 'POST',
                        url: applicationConstants.LOAD_TASKS_FROM_SERVER_ERL,
                        contentType: 'application/json',
                        data: JSON.stringify(requestBody),
                        success: function (data) {                         
                            function populateTasksDropdown(tasks) {
                                var selectList = document.createElement("select");
                                selectList.setAttribute("id", "tasks");
                                selectList.setAttribute("name", "tasks");
                                choiceGraphic.appendChild(selectList);
                                for (var i = 0; i < tasks.length; i++) {
                                    var option = document.createElement("option");
                                    option.setAttribute("value", i);
                                    option.text = tasks[i].uid;
                                    selectList.appendChild(option);
                                }
                            }
                            applicationContext.tasks = data.tasks;
                            populateTasksDropdown(data.tasks);
                        }    
                    });    
                }
            }); 
        }

        function printTaskGraphic() {
            document.getElementById("chartdiv").innerHTML = "";
            var taskToPrintIndex = $("#tasks").val(); 
            var taskToPrint = applicationContext.tasks[taskToPrintIndex];
            var inquiryPoints = {
                "numberOfPoints": applicationConstants.NUMBER_OF_NORMAL_DISTRIBUTION_POINTS, 
                "tasks": [taskToPrint]
            };

            $.ajax({
                type: 'POST',
                url: applicationConstants.LOAD_NORMAL_DISTRIBUTION_FROM_SERVER_URL,
                contentType: 'application/json',
                data: JSON.stringify(inquiryPoints),
                success: function drawTaskGraphic(data) {
                    var taskNormalDistribution = data.taskNormalDistributions[0];
                    var line = [];
                    for(var i = 0, iLen = taskNormalDistribution['x'].length; i < iLen; i++){
                        line.push([taskNormalDistribution['x'][i], taskNormalDistribution['y'][i]]); 
                    }

                    var plot = $.jqplot ('chartdiv', [line], {
                        title: taskNormalDistribution["taskUid"],
                        textColor:"#6A5ACD",            
                        grid:{
                            borderWidth:4.0,
                            gridLineColor: "#CCCCFF"
                        },        
                        axes:{
                            yaxis:{
                                min:0, 
                                max:1,
                                tickInterval:0.1
                            },   
                            xaxis:{
                                min:0, 
                                max:taskNormalDistribution['max_x']+1,
                                numberTicks: taskNormalDistribution['max_x']+2,
                                tickInterval:1
                            }
                        }, 
                        series:[{color:'#293133'}],   
                        axesDefaults:{min:0},            
                        seriesDefaults:{
                            showMarker:false,  
                            lineWidth: 3.5
                        }   
                    });                   
                }       
            });
        };

        function buildRoadMap() {
            document.getElementById("error").innerHTML = "";
            var misstep = '';
            var numberOfWorkers = +$('#workes').val();
            if(!numberOfWorkers || typeof numberOfWorkers === 'string'){
                misstep = "Number of workers should be not empty and contain number";
                document.getElementById("error").innerHTML = misstep;
            }else{
                printRoadMap(numberOfWorkers);
            }
        	function printRoadMap(numberOfWorkers){
        		var requestBody = {
    				"numberOfWorkers": numberOfWorkers, 
    				"tasks": applicationContext.tasks
				} 

	        	$.ajax({
		        	type: 'POST',
					url: applicationConstants.LOAD_ROAD_MAP_FROM_SERVER_URL,
					contentType: 'application/json',
					data: JSON.stringify(requestBody),
					success: function drawRoadMap(data) {
						var viewMassif = data.roadMap;
						am4core.useTheme(am4themes_animated);
						var chart = am4core.create("creationChart", am4charts.XYChart);
						chart.hiddenState.properties.opacity = 0; // this creates initial fade-in
						chart.paddingRight = 300;
						var colorSet = new am4core.ColorSet();
						colorSet.saturation = 0.6;

						chart.data = [];		
						for( var i=0, iGet = viewMassif.length; i<iGet; i++){
							var ser = viewMassif[i]["work"];
							for( var j=0, iSet = ser.length; j<iSet; j++){
								var lans = {};
								var noun;
								if (ser[j]["task_uid"]==null) continue;
								lans.ordinate = ser[j]["task_uid"];
								lans.name = ser[j]["worker"]; 
								noun = (+lans.name.charAt(lans.name.length-1)) * 6;
								lans.color =  colorSet.getIndex(noun);         
								lans.fromDate = viewMassif[i]["day"] - 1;
								lans.toDate = viewMassif[i]["day"];
								chart.data.push(lans);				
							}
						}

				        var categoryAxis = chart.yAxes.push(new am4charts.CategoryAxis());
				        categoryAxis.dataFields.category = "ordinate";
				        categoryAxis.renderer.grid.template.location = 0;
				        categoryAxis.renderer.inversed = true;

				        var valueAxis = chart.xAxes.push(new am4charts.ValueAxis());
				        valueAxis.renderer.minGridDistance = 1;

				        var series1 = chart.series.push(new am4charts.ColumnSeries());
				        series1.columns.template.width = am4core.percent(80);
				        series1.columns.template.tooltipText = "{name}";

				        series1.dataFields.openValueX = "fromDate";
				        series1.dataFields.valueX = "toDate";
				        series1.dataFields.categoryY = "ordinate";
				        series1.columns.template.propertyFields.fill = "color"; // get color from data
				        series1.columns.template.propertyFields.stroke = "color";
				        series1.columns.template.strokeOpacity = 1;
				    }
	        	});          
        	}
        }

        $("#loadTasksButton").click(loadTasks);       
        $("#printGraphicButton").click(printTaskGraphic);        
        $("#printMapButton").click(buildRoadMap);

    </script>
</body>
</html>